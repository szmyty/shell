#!/usr/bin/env bash
# shellcheck shell=bash
set -Eeuo pipefail

# ------------------------------------------------------------------------------
# git-remove-exec-no-shebang
#
# Removes the executable bit (+x) from git-visible files that do not start
# with a shebang (#!).
# ------------------------------------------------------------------------------

VERSION="1.3.0"
QUIET=false

# ------------------------------------------------------------------------------
# Bootstrap shell library
# ------------------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
source "${SCRIPT_DIR}/../shell.sh"

# ------------------------------------------------------------------------------
# Helpers (policy lives here)
# ------------------------------------------------------------------------------

die() {
  local code="$1"; shift || true
  log::error "$*"
  exit "${code}"
}

usage() {
  cat <<'EOF'
Usage:
  git-remove-exec-no-shebang [options]

Removes the executable bit (+x) from git-visible files that do not start
with a shebang (#!).

Options:
  --quiet         Suppress per-file output
  -h, --help      Show this help message
  -v, --version   Show version and exit
EOF
}

# ------------------------------------------------------------------------------
# CLI parsing
# ------------------------------------------------------------------------------

while [[ $# -gt 0 ]]; do
  case "$1" in
    --quiet)
      QUIET=true
      ;;
    -h|--help)
      usage; exit 0
      ;;
    -v|--version)
      printf 'git-remove-exec-no-shebang v%s\n' "${VERSION}"
      exit 0
      ;;
    -*)
      die 1 "Unknown option: $1"
      ;;
  esac
  shift
done

# ------------------------------------------------------------------------------
# Main
# ------------------------------------------------------------------------------

main() {
  git rev-parse --is-inside-work-tree >/dev/null 2>&1 ||
    die 1 "Not inside a Git repository."

  log::info "Scanning git-visible files for invalid executable bitsâ€¦"

  local count=0
  local file

  mapfile -d '' files < <(
    git ls-files --cached --others --exclude-standard -z || true
  )

  for file in "${files[@]}"; do
    [[ -f "${file}" ]] || continue

    if fs::is_executable "${file}" && ! fs::has_shebang "${file}"; then
      chmod -x "${file}"
      ((count++))
      [[ "${QUIET}" == true ]] ||
        log::warn "Removed exec bit: ${file}"
    fi
  done

  if ((count == 0)); then
    log::success "No invalid exec bits found. Repo is clean."
  else
    log::success "Stripped exec bit from ${count} file(s)."
  fi
}

main "$@"
